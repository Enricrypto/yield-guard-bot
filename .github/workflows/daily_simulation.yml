name: Daily Simulation

on:
  schedule:
    # Run every day at 2:00 AM UTC (9:00 PM EST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  simulate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create data directory
      run: mkdir -p data

    - name: Restore previous database
      uses: actions/cache/restore@v4
      id: cache-db-restore
      with:
        path: data/simulations.db
        key: simulation-db-${{ github.run_number }}
        restore-keys: |
          simulation-db-

    - name: Run daily simulation
      run: |
        python scripts/daily_simulation.py --capital 1000000 --days 1
      env:
        PYTHONUNBUFFERED: 1

    - name: Save database
      uses: actions/cache/save@v4
      if: always()
      with:
        path: data/simulations.db
        key: simulation-db-${{ github.run_number }}

    - name: Generate summary report
      if: always()
      run: |
        python scripts/daily_simulation.py --summary-only > simulation_summary.txt
        cat simulation_summary.txt

    - name: Upload simulation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: simulation-results-${{ github.run_number }}
        path: |
          data/simulations.db
          simulation_summary.txt
        retention-days: 90

    - name: Add results to summary
      if: always()
      run: |
        echo "## Daily Simulation Results üìä" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Summary" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat simulation_summary.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Check for significant losses
      run: |
        # Extract return from summary and check if it's a significant loss
        python -c "
        import sys
        try:
            with open('simulation_summary.txt', 'r') as f:
                content = f.read()
                # Look for return percentage
                if 'Return:' in content:
                    for line in content.split('\n'):
                        if 'Return:' in line and '%' in line:
                            # Extract percentage value
                            return_str = line.split('Return:')[1].split('%')[0].strip()
                            return_pct = float(return_str)
                            if return_pct < -2.0:  # Alert if loss > 2%
                                print(f'‚ö†Ô∏è ALERT: Significant loss detected: {return_pct}%')
                                sys.exit(1)
                            elif return_pct < 0:
                                print(f'‚ö†Ô∏è Warning: Negative return: {return_pct}%')
                            else:
                                print(f'‚úì Positive return: {return_pct}%')
        except Exception as e:
            print(f'Could not parse return value: {e}')
            sys.exit(0)  # Don't fail the workflow
        "

  notify:
    runs-on: ubuntu-latest
    needs: simulate
    if: failure()

    steps:
    - name: Notification on failure
      run: |
        echo "Daily simulation failed or detected significant losses"
        echo "Check the workflow logs for details"
        # In production, you could add Slack/email notifications here
