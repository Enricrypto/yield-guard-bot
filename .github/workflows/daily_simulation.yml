name: Daily Simulation

on:
  schedule:
    - cron: "0 2 * * *" # Every day at 2 AM UTC
  workflow_dispatch: # Manual trigger

jobs:
  simulate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Cache pip dependencies
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      # 5Ô∏è‚É£ Run tests ‚úÖ
      - name: Run tests
        env:
          PYTHONPATH: .
        run: python -m pytest tests/ -v --tb=short

      # 6Ô∏è‚É£ Create data directory
      - name: Create data directory
        run: mkdir -p data

      # 7Ô∏è‚É£ Restore previous database
      - name: Restore previous database
        uses: actions/cache@v4
        id: cache-db-restore
        with:
          path: data/simulations.db
          key: simulation-db-${{ github.run_number }}
          restore-keys: |
            simulation-db-

      # 8Ô∏è‚É£ Run daily simulation
      - name: Run daily simulation
        env:
          PYTHONPATH: .
          PYTHONUNBUFFERED: 1
        run: python scripts/daily_simulation.py --capital 1000000 --days 1 || true

      # 9Ô∏è‚É£ Save database
      - name: Save database
        uses: actions/cache@v4
        if: always()
        with:
          path: data/simulations.db
          key: simulation-db-${{ github.run_number }}

      # üîü Generate summary report
      - name: Generate summary report
        if: always()
        env:
          PYTHONPATH: .
        run: |
          python scripts/daily_simulation.py --summary-only > simulation_summary.txt || true
          cat simulation_summary.txt

      # 11Ô∏è‚É£ Upload simulation results
      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: simulation-results-${{ github.run_number }}
          path: |
            data/simulations.db
            simulation_summary.txt
          retention-days: 90

      # 12Ô∏è‚É£ Add results to GitHub Step Summary
      - name: Add results to summary
        if: always()
        run: |
          echo "## Daily Simulation Results üìä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat simulation_summary.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # 13Ô∏è‚É£ Check for significant losses
      - name: Check for significant losses
        if: always()
        run: python scripts/check_loss.py

  notify:
    runs-on: ubuntu-latest
    needs: simulate
    if: failure()
    steps:
      - name: Notification on failure
        run: |
          echo "Daily simulation failed or detected significant losses"
          echo "Check the workflow logs for details"
